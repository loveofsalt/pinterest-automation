name: Pinterest Batch Pin Creator

on:
  # Manual trigger only - no automatic processing
  workflow_dispatch:
    inputs:
      csv_file:
        description: 'Path to CSV file (e.g., pins/batch_2026_01_07.csv)'
        required: true
        default: 'pins/batch_YYYY_MM_DD.csv'
      archive_after_success:
        description: 'Archive CSV file after successful processing'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  create-pins:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Verify CSV file exists
      run: |
        CSV_PATH="${{ github.event.inputs.csv_file }}"
        if [ ! -f "$CSV_PATH" ]; then
          echo "‚ùå CSV file not found: $CSV_PATH"
          exit 1
        fi
        echo "‚úÖ Found CSV file: $CSV_PATH"
        
    - name: Show CSV contents
      run: |
        echo "üìã CSV Contents:"
        cat "${{ github.event.inputs.csv_file }}"
        
    - name: Verify image files exist
      run: |
        echo "üîç Checking if all image files in CSV exist..."
        go run check_images.go "${{ github.event.inputs.csv_file }}"
        
    - name: Create Pinterest Pins
      env:
        PINTEREST_APP_ID: ${{ secrets.PINTEREST_APP_ID }}
        PINTEREST_APP_SECRET: ${{ secrets.PINTEREST_APP_SECRET }}
        PINTEREST_REFRESH_TOKEN: ${{ secrets.PINTEREST_REFRESH_TOKEN }}
        PINTEREST_BOARD_ID: ${{ secrets.PINTEREST_BOARD_ID }}
        INPUT_CSV_PATH: ${{ github.event.inputs.csv_file }}
      run: |
        echo "üöÄ Starting batch pin creation..."
        go run main.go
        
    - name: Archive processed CSV
      if: success() && github.event.inputs.archive_after_success == 'true'
      run: |
        # Create archive directory if it doesn't exist
        mkdir -p pins/archive
        
        # Move CSV to archive with timestamp
        CSV_PATH="${{ github.event.inputs.csv_file }}"
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        BASENAME=$(basename "$CSV_PATH" .csv)
        ARCHIVE_NAME="pins/archive/${BASENAME}_processed_${TIMESTAMP}.csv"
        
        mv "$CSV_PATH" "$ARCHIVE_NAME"
        echo "üì¶ Archived CSV to: $ARCHIVE_NAME"
        
        # Commit the archive
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pins/archive/
        git commit -m "üì¶ Archive processed batch: $(basename "$CSV_PATH")" || exit 0
        git push
